<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modbus Inverter Simulator (JS)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent: #007acc;
            --success: #4caf50;
            --error: #f44336;
            --border: #3e3e3e;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            box-sizing: border-box;
        }
        h1, h2, h3 { margin: 0 0 10px 0; }
        
        /* Top Bar */
        .top-bar {
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        select, input, button {
            background-color: #3d3d3d;
            border: 1px solid var(--border);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
        }
        button {
            background-color: var(--accent);
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { filter: brightness(1.1); }
        button:disabled { filter: grayscale(1); cursor: not-allowed; }
        
        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            overflow: hidden; /* Fix for inner scrolling */
        }
        
        /* Panels */
        .panel {
            background-color: var(--panel-bg);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .card {
            background-color: #383838;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .card-label { font-size: 0.9em; color: #aaa; margin-bottom: 5px; }
        .card-value { font-size: 1.5em; font-weight: bold; color: var(--accent); }
        .card-unit { font-size: 0.8em; color: #aaa; }
        
        .control-group {
            margin-top: 10px;
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        .control-group input { width: 60px; }
        
        /* Logs */
        .log-container {
            flex: 1;
            background-color: #111;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        .log-entry { margin: 2px 0; border-bottom: 1px solid #222; }
        .log-rx { color: #4caf50; }
        .log-tx { color: #2196f3; }
        .log-err { color: #f44336; }
        .log-info { color: #aaa; }

        /* Reg Table */
        .reg-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .reg-table th, .reg-table td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        .reg-table th { color: #aaa; }
        .reg-val { font-family: monospace; color: var(--accent); }
    </style>
</head>
<body>

    <div class="top-bar">
        <h2>Inverter Simulator</h2>
        <select id="port-select"><option>Loading...</option></select>
        <select id="baud-select">
            <option value="9600">9600</option>
            <option value="19200">19200</option>
            <option value="38400">38400</option>
            <option value="115200">115200</option>
        </select>
        <button id="btn-start" onclick="startServer()">Start Server</button>
        <span id="status-badge" style="margin-left:auto; color: #888;">Stopped</span>
    </div>

    <div class="main-grid">
        <!-- Left Column: Dashboard & Controls -->
        <div class="panel">
            <h3>Live Status (IDs 1-5, 110-114)</h3>
            <div class="dashboard">
                <!-- Freq -->
                <div class="card">
                    <div class="card-label">Frequency</div>
                    <div class="card-value" id="disp-freq">50.00</div>
                    <div class="card-unit">Hz</div>
                    <div class="control-group">
                        <input type="number" id="set-freq" value="50.0">
                        <button onclick="setReg(0x3000, 'set-freq', 100)">Set</button>
                    </div>
                </div>
                <!-- Volt -->
                <div class="card">
                    <div class="card-label">Voltage</div>
                    <div class="card-value" id="disp-volt">220.0</div>
                    <div class="card-unit">V</div>
                    <div class="control-group">
                        <input type="number" id="set-volt" value="220.0">
                        <button onclick="setReg(0x3002, 'set-volt', 10)">Set</button>
                    </div>
                </div>
                <!-- Current -->
                <div class="card">
                    <div class="card-label">Current</div>
                    <div class="card-value" id="disp-curr">5.0</div>
                    <div class="card-unit">A</div>
                    <div class="control-group">
                        <input type="number" id="set-curr" value="5.0">
                        <button onclick="setReg(0x3003, 'set-curr', 10)">Set</button>
                    </div>
                </div>
                <!-- Power -->
                <div class="card">
                    <div class="card-label">Power</div>
                    <div class="card-value" id="disp-pwr">1.1</div>
                    <div class="card-unit">kW</div>
                    <div class="control-group">
                        <input type="number" id="set-pwr" value="1.1">
                        <button onclick="setReg(0x3004, 'set-pwr', 10)">Set</button>
                    </div>
                </div>
            </div>

            <h3 style="margin-top:20px;">Key Registers</h3>
            <div style="overflow-y:auto; flex:1">
                <table class="reg-table">
                    <thead><tr><th>Addr</th><th>Name</th><th>Value</th><th>Hex</th></tr></thead>
                    <tbody id="reg-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Right Column: Logs -->
        <div class="panel">
            <h3>Bus Traffic</h3>
            <div class="log-container" id="log-box"></div>
            <button onclick="document.getElementById('log-box').innerHTML=''" style="margin-top:10px; background:#444;">Clear Log</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        // --- State ---
        const registers = {};
        const map = [
            { a: 0x2000, n: "Control Cmd", s: 1 },
            { a: 0x3000, n: "Frequency", s: 100 },
            { a: 0x3002, n: "Voltage", s: 10 },
            { a: 0x3003, n: "Current", s: 10 },
            { a: 0x3004, n: "Power", s: 10 },
            { a: 0x3005, n: "Speed", s: 1 },
            { a: 0x3006, n: "Bus Volt", s: 10 },
            { a: 0x3017, n: "Temp", s: 10 },
            { a: 0x3023, n: "Energy", s: 1 },
            { a: 0x8200, n: "Start Mode", s: 1 },
            { a: 0x0B15, n: "Temp SP", s: 1 },
            { a: 0x0300, n: "Freq (03xx)", s: 100 }
        ];

        // --- Init ---
        async function init() {
            // Fetch Ports
            const res = await fetch('/api/ports');
            const ports = await res.json();
            const sel = document.getElementById('port-select');
            sel.innerHTML = ports.map(p => `<option value="${p}">${p}</option>`).join('');
            
            // Render Table
            const tbody = document.getElementById('reg-table-body');
            tbody.innerHTML = map.map(r => `
                <tr id="row-${r.a}">
                    <td>0x${r.a.toString(16).toUpperCase()}</td>
                    <td>${r.n}</td>
                    <td class="reg-val" id="val-${r.a}">-</td>
                    <td class="reg-val" id="hex-${r.a}">-</td>
                </tr>
            `).join('');
        }
        init();

        // --- Actions ---
        function startServer() {
            const port = document.getElementById('port-select').value;
            const baud = document.getElementById('baud-select').value;
            socket.emit('start-server', { port, baud });
            document.getElementById('btn-start').innerText = "Starting...";
            document.getElementById('btn-start').disabled = true;
        }

        function setReg(addr, inputId, scale) {
            const val = parseFloat(document.getElementById(inputId).value);
            const intVal = Math.round(val * scale);
            socket.emit('set-register', { addr, val: intVal });
        }

        // --- Socket Handling ---
        socket.on('server-status', (running) => {
            const badge = document.getElementById('status-badge');
            const btn = document.getElementById('btn-start');
            if (running) {
                badge.innerText = "RUNNING";
                badge.style.color = "#4caf50";
                btn.innerText = "Running";
            } else {
                badge.innerText = "STOPPED";
                badge.style.color = "#f44336";
                btn.innerText = "Start Server";
                btn.disabled = false;
            }
        });

        socket.on('log', (entry) => {
            const box = document.getElementById('log-box');
            const div = document.createElement('div');
            div.className = `log-entry log-${entry.type.toLowerCase()}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${entry.msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        });

        socket.on('initial-state', (state) => {
            for (const [addr, val] of Object.entries(state)) {
                updateReg(parseInt(addr), val);
            }
        });

        socket.on('reg-update', ({ addr, val }) => {
            updateReg(addr, val);
        });

        function updateReg(addr, val) {
            registers[addr] = val;
            
            // Update Table
            const elVal = document.getElementById(`val-${addr}`);
            const elHex = document.getElementById(`hex-${addr}`);
            if (elVal) {
                elVal.innerText = val;
                elHex.innerText = `0x${val.toString(16).toUpperCase().padStart(4, '0')}`;
            }

            // Update Dashboard Cards
            if (addr === 0x3000 || addr === 0x0300) updateCard('disp-freq', val, 100);
            if (addr === 0x3002 || addr === 0x0302) updateCard('disp-volt', val, 10);
            if (addr === 0x3003 || addr === 0x0303) updateCard('disp-curr', val, 10);
            if (addr === 0x3004 || addr === 0x0304) updateCard('disp-pwr', val, 10);
        }

        function updateCard(id, val, scale) {
            document.getElementById(id).innerText = (val / scale).toFixed(scale > 1 ? 2 : 0);
        }

    </script>
</body>
</html>
