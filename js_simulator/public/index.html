<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modbus Inverter Simulator</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent: #007acc;
            --success: #4caf50;
            --error: #f44336;
            --border: #3e3e3e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            height: 100vh;
            box-sizing: border-box;
        }

        h1,
        h2,
        h3 {
            margin: 0 0 10px 0;
        }

        /* Top Bar */
        .top-bar {
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
        }

        select,
        input,
        button {
            background-color: #3d3d3d;
            border: 1px solid var(--border);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
        }

        button {
            background-color: var(--accent);
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            filter: brightness(1.1);
        }

        button:disabled {
            filter: grayscale(1);
            cursor: not-allowed;
        }

        button.stop-btn {
            background-color: var(--error);
        }

        button.run-btn {
            background-color: var(--success);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab-btn {
            padding: 10px 20px;
            background-color: #383838;
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            color: #aaa;
        }

        .tab-btn.active {
            background-color: var(--panel-bg);
            color: var(--accent);
            font-weight: bold;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            overflow: hidden;
        }

        /* Panels */
        .panel {
            background-color: var(--panel-bg);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .card {
            background-color: #383838;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .card-label {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 5px;
        }

        .card-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent);
        }

        .card-unit {
            font-size: 0.8em;
            color: #aaa;
        }

        .control-group {
            margin-top: 10px;
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .control-group input {
            width: 60px;
        }

        /* Actions */
        .action-bar {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Reg Table */
        .reg-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            margin-top: 15px;
        }

        .reg-table th,
        .reg-table td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }

        .reg-table th {
            color: #aaa;
        }

        .reg-val {
            font-family: monospace;
            color: var(--accent);
        }

        /* Logs */
        .log-container {
            flex: 1;
            background-color: #111;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin: 2px 0;
            border-bottom: 1px solid #222;
        }

        .log-rx {
            color: #4caf50;
        }

        .log-tx {
            color: #2196f3;
        }

        .log-err {
            color: #f44336;
        }

        .log-info {
            color: #aaa;
        }
    </style>
</head>

<body>

    <div class="top-bar">
        <h2>Inverter Simulator</h2>
        <select id="port-select">
            <option>Loading...</option>
        </select>
        <select id="baud-select">
            <option value="9600">9600</option>
            <option value="19200">19200</option>
        </select>
        <button id="btn-start" onclick="startServer()">Start Server</button>
        <button id="btn-stop" onclick="stopServer()" class="stop-btn" disabled>Stop Server</button>
        <span id="status-badge" style="margin-left:auto; color: #888;">Stopped</span>
    </div>

    <div class="tabs" id="tab-container">
        <!-- Generated by JS -->
    </div>

    <div class="main-grid">
        <div class="panel">
            <h3>Inverter <span id="current-id">1</span> Status <label style="margin-left:20px; font-size:0.8em;"><input
                        type="checkbox" id="enable-checkbox" checked onchange="toggleInverter(this.checked)">
                    Enabled</label></h3>
            <div class="dashboard" id="dashboard">
                <!-- Generated by JS -->
            </div>

            <h3 style="margin-top:20px;">Key Registers</h3>
            <div style="overflow-y:auto; flex:1; max-height:200px;">
                <table class="reg-table">
                    <thead>
                        <tr>
                            <th>Addr</th>
                            <th>Name</th>
                            <th>Value</th>
                            <th>Hex</th>
                        </tr>
                    </thead>
                    <tbody id="reg-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <h3>Bus Traffic</h3>
            <div class="log-container" id="log-box"></div>
            <button onclick="document.getElementById('log-box').innerHTML=''"
                style="margin-top:10px; background:#444;">Clear Log</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const SLAVE_IDS = [1, 2, 3, 4, 5];
        let currentID = 1;

        // Per-ID state
        const state = {};
        const inverterEnabled = {};
        SLAVE_IDS.forEach(id => {
            state[id] = {};
            inverterEnabled[id] = true;
        });

        const map = [
            { a: 0x3000, n: "Frequency", s: 100, u: "Hz" },
            { a: 0x3002, n: "Voltage", s: 10, u: "V" },
            { a: 0x3003, n: "Current", s: 10, u: "A" },
            { a: 0x3004, n: "Power", s: 10, u: "kW" },
            { a: 0x3005, n: "Speed", s: 1, u: "rpm" },
            { a: 0x3006, n: "Bus V", s: 10, u: "V" },
            { a: 0x3017, n: "Temp", s: 10, u: "Â°C" },
            { a: 0x3023, n: "Energy", s: 1, u: "kWh" }
        ];

        const allRegs = [
            // Control (Write-only)
            { a: 0x2000, n: "Control Command" },

            // Status registers (Read-only) - 0x30xx Range
            { a: 0x3000, n: "Frequency Running" },
            { a: 0x3002, n: "Voltage Output" },
            { a: 0x3003, n: "Current Output" },
            { a: 0x3004, n: "Power Output" },
            { a: 0x3005, n: "Motor Speed (Est)" },
            { a: 0x3006, n: "Bus Voltage" },
            { a: 0x3017, n: "Inverter Temp" },
            { a: 0x3023, n: "Total Energy (kWh)" },
            { a: 0x3100, n: "Fault Code" },

            // Parameter registers - 0x8xxx
            { a: 0x8000, n: "User Password" },
            { a: 0x8001, n: "Display Params" },
            { a: 0x8006, n: "Param Edit Mode" },
            { a: 0x8200, n: "Start Cmd Mode" },
            { a: 0x840A, n: "Device ID" },

            // Other FR500A Registers
            { a: 0x0B15, n: "Temp Setpoint" },

            // Mirrored addresses (0x03xx = U00 Group)
            { a: 0x0300, n: "U00.00 Frequency" },
            { a: 0x0302, n: "U00.02 Voltage" },
            { a: 0x0303, n: "U00.03 Current" },
            { a: 0x0304, n: "U00.04 Power" },
            { a: 0x0305, n: "U00.05 Speed" },
            { a: 0x0306, n: "U00.06 Bus V" },
            { a: 0x0317, n: "U00.23 Temp" },
            { a: 0x0323, n: "U00.35 Energy" }
        ];

        // --- Init ---
        async function init() {
            // Fetch Ports
            const res = await fetch('/api/ports');
            const ports = await res.json();
            const sel = document.getElementById('port-select');
            sel.innerHTML = ports.map(p => `<option value="${p}">${p}</option>`).join('');

            // Generate Tabs
            const tabContainer = document.getElementById('tab-container');
            tabContainer.innerHTML = SLAVE_IDS.map(id =>
                `<button class="tab-btn ${id === 1 ? 'active' : ''}" onclick="selectTab(${id})">Inverter ${id}</button>`
            ).join('');

            // Generate Dashboard Cards
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = map.map(r => `
                <div class="card">
                    <div class="card-label">${r.n}</div>
                    <div class="card-value" id="val-${r.a}">-</div>
                    <div class="card-unit">${r.u}</div>
                    <div class="control-group">
                        <input type="number" id="set-${r.a}" value="0">
                        <button onclick="setReg(${r.a}, 'set-${r.a}', ${r.s})">Set</button>
                    </div>
                </div>
            `).join('');

            // Generate Register Table
            const tbody = document.getElementById('reg-table-body');
            tbody.innerHTML = allRegs.map(r => `
                <tr id="row-${currentID}-${r.a}">
                    <td>0x${r.a.toString(16).toUpperCase().padStart(4, '0')}</td>
                    <td>${r.n}</td>
                    <td class="reg-val" id="tval-${r.a}">-</td>
                    <td class="reg-val" id="thex-${r.a}">-</td>
                </tr>
            `).join('');
        }
        init();

        function selectTab(id) {
            currentID = id;
            document.getElementById('current-id').innerText = id;
            document.getElementById('enable-checkbox').checked = inverterEnabled[id];

            // Update active tab style
            document.querySelectorAll('.tab-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', SLAVE_IDS[idx] === id);
            });

            // Refresh displayed values from state
            map.forEach(r => {
                const val = state[id][r.a] || 0;
                document.getElementById(`val-${r.a}`).innerText = (val / r.s).toFixed(r.s > 1 ? 2 : 0);
            });
        }

        // --- Actions ---
        function startServer() {
            const port = document.getElementById('port-select').value;
            const baud = document.getElementById('baud-select').value;
            socket.emit('start-server', { port, baud });
        }

        function stopServer() {
            socket.emit('stop-server');
        }

        function toggleInverter(enabled) {
            socket.emit('toggle-inverter', { id: currentID, enabled });
        }

        function setReg(addr, inputId, scale) {
            const val = parseFloat(document.getElementById(inputId).value);
            const intVal = Math.round(val * scale);
            socket.emit('set-register', { id: currentID, addr, val: intVal });
        }

        function sendCommand(cmd) {
            socket.emit('set-register', { id: currentID, addr: 0x2000, val: cmd });
        }

        // --- Socket Handling ---
        socket.on('server-status', (running) => {
            const badge = document.getElementById('status-badge');
            badge.innerText = running ? "RUNNING" : "STOPPED";
            badge.style.color = running ? "#4caf50" : "#f44336";
            document.getElementById('btn-start').disabled = running;
            document.getElementById('btn-stop').disabled = !running;
        });

        socket.on('log', (entry) => {
            const box = document.getElementById('log-box');
            const div = document.createElement('div');
            div.className = `log-entry log-${entry.type.toLowerCase()}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${entry.msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        });

        socket.on('initial-state', (allData) => {
            for (const id in allData) {
                if (state[id]) {
                    for (const addr in allData[id]) {
                        state[id][parseInt(addr)] = allData[id][addr];
                    }
                }
            }
            selectTab(currentID); // Refresh UI
        });

        socket.on('reg-update', ({ id, addr, val }) => {
            if (state[id]) {
                state[id][addr] = val;
            }
            // If this is the currently viewed tab, update UI
            if (id === currentID) {
                const mapItem = map.find(m => m.a === addr);
                if (mapItem) {
                    document.getElementById(`val-${addr}`).innerText = (val / mapItem.s).toFixed(mapItem.s > 1 ? 2 : 0);
                }
                // Update register table
                const tval = document.getElementById(`tval-${addr}`);
                const thex = document.getElementById(`thex-${addr}`);
                if (tval) {
                    tval.innerText = val;
                    thex.innerText = `0x${val.toString(16).toUpperCase().padStart(4, '0')}`;
                }
            }
        });

        socket.on('inverter-status', ({ id, enabled }) => {
            inverterEnabled[id] = enabled;
            if (id === currentID) {
                document.getElementById('enable-checkbox').checked = enabled;
            }
            // Update tab style to show disabled
            const tabIdx = SLAVE_IDS.indexOf(id);
            if (tabIdx >= 0) {
                const tabBtn = document.querySelectorAll('.tab-btn')[tabIdx];
                tabBtn.style.opacity = enabled ? '1' : '0.5';
            }
        });

        socket.on('all-inverter-status', (status) => {
            for (const id in status) {
                inverterEnabled[parseInt(id)] = status[id];
            }
            selectTab(currentID);
            SLAVE_IDS.forEach((id, idx) => {
                const tabBtn = document.querySelectorAll('.tab-btn')[idx];
                tabBtn.style.opacity = inverterEnabled[id] ? '1' : '0.5';
            });
        });

        // Request initial status
        socket.emit('get-inverter-status');

    </script>
</body>

</html>