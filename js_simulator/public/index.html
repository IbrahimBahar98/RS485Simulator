<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modbus Device Simulator</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="top-bar">
        <h2>Device Simulator</h2>
        <div style="display:flex; align-items:center;">
            <select id="port-select">
                <option>Loading...</option>
            </select>
            <button onclick="refreshPorts()" style="margin-left:5px; padding:2px 8px; font-size:1.2em;"
                title="Refresh Serial Ports">â†»</button>
        </div>
        <select id="baud-select">
            <option value="9600">9600</option>
            <option value="19200">19200</option>
        </select>
        <button id="btn-start" onclick="startServer()">Start Server</button>
        <button id="btn-stop" onclick="stopServer()" class="stop-btn" disabled>Stop Server</button>
        <span id="status-badge" style="margin-left:auto; color: #888;">Stopped</span>
    </div>

    <div class="tabs" id="tab-container">
        <!-- Generated by JS -->
    </div>

    <!-- Add Device Form -->
    <div id="add-device-form"
        style="display:none; background:#2d2d2d; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #3e3e3e;">
        <h3 style="margin-top:0;">Add New Device</h3>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <label>Slave ID: <input type="number" id="new-slave-id" min="1" max="247" value="1"
                    style="width:60px;"></label>
            <label>Type:
                <select id="new-device-type">
                    <option value="inverter">Inverter (FR500A)</option>
                    <option value="flowmeter">Flow Meter (CR009)</option>
                    <option value="energymeter">Energy Meter (ADL400)</option>
                </select>
            </label>
            <button onclick="addDevice()" class="run-btn">Add Device</button>
            <button onclick="hideAddForm()" style="background:#666;">Cancel</button>
        </div>
    </div>

    <div class="main-grid">
        <div class="panel">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:10px;">
                <h3>Slave ID: <span id="current-id">-</span></h3>
                <select id="device-type-select" onchange="changeDeviceType(this.value)">
                    <option value="inverter">Inverter (FR500A)</option>
                    <option value="flowmeter">Flow Meter (CR009)</option>
                    <option value="energymeter">Energy Meter (ADL400)</option>
                </select>
                <label style="font-size:0.8em;"><input type="checkbox" id="enable-checkbox" checked
                        onchange="toggleInverter(this.checked)">
                    Enabled</label>
                <button onclick="removeCurrentDevice()" class="stop-btn"
                    style="margin-left:auto; padding:5px 10px;">Remove Device</button>
            </div>

            <!-- Inner Grid: Dashboard Cards (left) + Key Registers (right) -->
            <div class="content-grid">
                <!-- Left Side: Dashboard Cards -->
                <div class="dashboard-section">
                    <h4 class="section-title">Dashboard</h4>
                    <!-- Inverter Status Bar (shown only for inverter type) -->
                    <div class="inverter-status-bar" id="inverter-status-bar" style="display:none;">
                        <div class="status-item">
                            <span class="status-label">Pump:</span>
                            <span class="status-badge stopped" id="pump-status">Stopped</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Lock:</span>
                            <span class="status-badge unlocked" id="lock-status">ðŸ”“ Unlocked</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Mode:</span>
                            <span class="status-badge mode-keypad" id="cmd-mode">Keypad</span>
                        </div>
                    </div>
                    <div class="dashboard" id="dashboard">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Right Side: Key Registers -->
                <div class="registers-section">
                    <h4 class="section-title">Key Registers</h4>
                    <div class="registers-container">
                        <table class="reg-table">
                            <thead>
                                <tr>
                                    <th>Addr</th>
                                    <th>Name</th>
                                    <th>Value</th>
                                    <th>Hex</th>
                                </tr>
                            </thead>
                            <tbody id="reg-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="add-register-form">
                        <input type="text" id="new-reg-addr" placeholder="Addr (Hex)">
                        <input type="text" id="new-reg-name" placeholder="Name">
                        <button onclick="addCustomRegister()" class="add-btn">+ Add</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>Bus Traffic</h3>
            <div class="log-container" id="log-box"></div>
            <button onclick="document.getElementById('log-box').innerHTML=''"
                style="margin-top:10px; background:#444;">Clear Log</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // --- Global Error Handlers ---
        window.onerror = function (msg, url, line, col, error) {
            const box = document.getElementById('log-box');
            if (box) {
                const div = document.createElement('div');
                div.className = 'log-entry log-err';
                div.innerText = `[JS Error] ${msg} (\n${url.split('/').pop()}:${line})`;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }
            return false; // Let default handler run too
        };

        window.onunhandledrejection = function (event) {
            const box = document.getElementById('log-box');
            if (box) {
                const div = document.createElement('div');
                div.className = 'log-entry log-err';
                div.innerText = `[JS Error] Unhandled Promise: ${event.reason}`;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }
        };

        // Dynamic devices list (loaded from server)
        let devicesList = []; // Array of {slaveId, type, enabled}
        let currentID = null;

        // Per-ID state
        const state = {};
        const inverterEnabled = {};
        const deviceTypes = {};

        // ===== INVERTER Dashboard Cards =====
        const inverterMap = [
            { a: 0x3000, n: "Frequency", s: 100, u: "Hz" },
            { a: 0x3002, n: "Voltage", s: 10, u: "V" },
            { a: 0x3003, n: "Current", s: 10, u: "A" },
            { a: 0x3004, n: "Power", s: 10, u: "kW" },
            { a: 0x3005, n: "Speed", s: 1, u: "rpm" },
            { a: 0x3006, n: "Bus V", s: 10, u: "V" },
            { a: 0x3017, n: "Temp", s: 10, u: "Â°C" },
            { a: 0x3023, n: "Energy", s: 1, u: "kWh" }
        ];

        // ===== FLOW METER Dashboard Cards =====
        // ===== FLOW METER Dashboard Cards =====
        // CR009 uses Big Endian word order (MSW at lower address)
        const flowMeterMap = [
            { a: 778, n: "Flow Rate", s: 1, u: "L/s", isFloat: true, lsw: 779 },
            { a: 772, n: "Fwd Total", s: 1, u: "L", uint32: true, lsw: 773 },
            { a: 812, n: "Conductivity", s: 1, u: "Î¼S/cm", isFloat: true, lsw: 813 },
            { a: 777, n: "Alarms", s: 1, u: "flags" }
        ];

        // ===== ENERGY METER (ADL400) Dashboard Cards =====
        const energyMeterMap = [
            // Voltage Phases (Floats - 2 registers each)
            { a: 0x0800, n: "Voltage Phase A", s: 1, u: "V", isFloat: true, lsw: 0x0801 },
            { a: 0x0802, n: "Voltage Phase B", s: 1, u: "V", isFloat: true, lsw: 0x0803 },
            { a: 0x0804, n: "Voltage Phase C", s: 1, u: "V", isFloat: true, lsw: 0x0805 },

            // Current Phases (Floats)
            { a: 0x080C, n: "Current Phase A", s: 1, u: "A", isFloat: true, lsw: 0x080D },
            { a: 0x080E, n: "Current Phase B", s: 1, u: "A", isFloat: true, lsw: 0x080F },
            { a: 0x0810, n: "Current Phase C", s: 1, u: "A", isFloat: true, lsw: 0x0811 },

            // Total Power & Parameters (Floats)
            { a: 0x060A, n: "Total Active Power", s: 1, u: "W", isFloat: true, lsw: 0x060B },
            { a: 0x0832, n: "Total Power Factor", s: 1, u: "PF", isFloat: true, lsw: 0x0833 },
            { a: 0x0834, n: "Frequency", s: 1, u: "Hz", isFloat: true, lsw: 0x0835 },

            // Energy Values (UInt32)
            { a: 0x0842, n: "Total Active Energy", s: 1, u: "kWh", uint32: true, lsw: 0x0843 },
            { a: 0x6002, n: "Daily Total Energy", s: 1, u: "kWh", uint32: true, lsw: 0x6003 },
            { a: 0x7002, n: "Monthly Total Energy", s: 1, u: "kWh", uint32: true, lsw: 0x7003 }
        ];

        // Current active map (changes based on device type)
        let map = inverterMap;

        // ===== INVERTER Registers =====
        const inverterRegs = [
            // Control (Write-only)
            { a: 0x2000, n: "Control Command" },
            // Status registers (Read-only) - 0x30xx Range
            { a: 0x3000, n: "Frequency Running" },
            { a: 0x3002, n: "Voltage Output" },
            { a: 0x3003, n: "Current Output" },
            { a: 0x3004, n: "Power Output" },
            { a: 0x3005, n: "Motor Speed (Est)" },
            { a: 0x3006, n: "Bus Voltage" },
            { a: 0x3017, n: "Inverter Temp" },
            { a: 0x3023, n: "Total Energy (kWh)" },
            { a: 0x3100, n: "Fault Code" },
            // Parameter registers - 0x8xxx
            { a: 0x8000, n: "User Password" },
            { a: 0x8001, n: "Display Params" },
            { a: 0x8006, n: "Param Edit Mode" },
            { a: 0x8200, n: "Start Cmd Mode" },
            { a: 0x840A, n: "Device ID" },
            // Other FR500A
            { a: 0x0B15, n: "Temp Setpoint" },
            // Mirrored addresses (0x03xx = U00 Group)
            { a: 0x0300, n: "U00.00 Frequency" },
            { a: 0x0302, n: "U00.02 Voltage" },
            { a: 0x0303, n: "U00.03 Current" },
            { a: 0x0304, n: "U00.04 Power" },
            { a: 0x0305, n: "U00.05 Speed" },
            { a: 0x0306, n: "U00.06 Bus Voltage" },
            { a: 0x0317, n: "U00.23 Temp" },
            { a: 0x3023, n: "U00.35 Energy" }
        ];

        // ===== FLOW METER Registers (Merged 32-bit values) =====
        // CR009 uses Big Endian word order (MSW at lower address)
        const flowMeterRegs = [
            // Input Registers (FC 04) - Readings
            { a: 772, n: "Forward Total", uint32: true, lsw: 773 },
            { a: 774, n: "Unit Info" },
            { a: 777, n: "Alarm Flags" },
            { a: 778, n: "Flow Rate", isFloat: true, lsw: 779 },
            { a: 786, n: "Fwd Overflow Count" },
            { a: 812, n: "Conductivity", isFloat: true, lsw: 813 },
            // Holding Registers (FC 03) - Config
            { a: 261, n: "Flow Range", isFloat: true, lsw: 262 },
            { a: 281, n: "Alarm High", isFloat: true, lsw: 282 },
            { a: 284, n: "Alarm Low", isFloat: true, lsw: 285 }
        ];

        // ===== ENERGY METER (ADL400) Registers (Merged 32-bit values) =====
        const energyMeterRegs = [
            // Voltage Registers (Floats)
            { a: 0x0800, n: "Phase A Voltage", isFloat: true, lsw: 0x0801 },
            { a: 0x0802, n: "Phase B Voltage", isFloat: true, lsw: 0x0803 },
            { a: 0x0804, n: "Phase C Voltage", isFloat: true, lsw: 0x0805 },

            // Current Registers (Floats)
            { a: 0x080C, n: "Phase A Current", isFloat: true, lsw: 0x080D },
            { a: 0x080E, n: "Phase B Current", isFloat: true, lsw: 0x080F },
            { a: 0x0810, n: "Phase C Current", isFloat: true, lsw: 0x0811 },

            // Power & Parameters (Floats)
            { a: 0x060A, n: "Total Active Power", isFloat: true, lsw: 0x060B },
            { a: 0x0832, n: "Total Power Factor", isFloat: true, lsw: 0x0833 },
            { a: 0x0834, n: "Frequency", isFloat: true, lsw: 0x0835 },

            // Energy Registers (UInt32)
            { a: 0x0842, n: "Total Active Energy (kWh)", uint32: true, lsw: 0x0843 },
            { a: 0x6002, n: "Daily Total Energy (kWh)", uint32: true, lsw: 0x6003 },
            { a: 0x7002, n: "Monthly Total Energy (kWh)", uint32: true, lsw: 0x7003 },

            // Configuration
            { a: 0x008D, n: "PT Ratio" },
            { a: 0x008E, n: "CT Ratio" },
            { a: 0x0100, n: "Device Address" },
            { a: 0x0101, n: "Baud Rate" }
        ];

        // Current active registers (changes based on device type)
        let allRegs = inverterRegs;
        let customRegs = {}; // { slaveId: [ {a: addr, n: name} ] }

        // --- Init ---
        async function init() {
            // Fetch Ports
            const res = await fetch('/api/ports');
            const ports = await res.json();
            const sel = document.getElementById('port-select');
            sel.innerHTML = ports.map(p => `<option value="${p}">${p}</option>`).join('');

            // Request devices list from server
            socket.emit('get-devices');
        }
        init();

        function updateTabs() {
            const tabContainer = document.getElementById('tab-container');
            let html = devicesList.map(d => {
                let label = 'INV';
                if (d.type === 'flowmeter') label = 'FM';
                else if (d.type === 'energymeter') label = 'EM';
                const opacity = d.enabled ? '1' : '0.5';
                return `<button class="tab-btn ${d.slaveId === currentID ? 'active' : ''}" style="opacity:${opacity}" onclick="selectTab(${d.slaveId})">${label} #${d.slaveId}</button>`;
            }).join('');
            html += `<button class="tab-btn" style="background:#4caf50;" onclick="showAddForm()">+ Add Device</button>`;
            tabContainer.innerHTML = html;
        }

        function showAddForm() {
            document.getElementById('add-device-form').style.display = 'block';
        }
        function hideAddForm() {
            document.getElementById('add-device-form').style.display = 'none';
        }

        function regenerateDashboard() {
            const type = deviceTypes[currentID] || 'inverter';
            if (type === 'flowmeter') map = flowMeterMap;
            else if (type === 'energymeter') map = energyMeterMap;
            else map = inverterMap;

            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = map.map(r => `
                <div class="card">
                    <div class="card-label">${r.n}</div>
                    <div class="card-value" id="val-${r.a}">-</div>
                    <div class="card-unit">${r.u}</div>
                    <div class="control-group">
                        <input type="number" id="set-${r.a}" value="0" step="${r.isFloat ? '0.1' : '1'}">
                        <button onclick="setReg(${r.a}, 'set-${r.a}', ${r.s}, ${!!r.isFloat}, ${!!r.uint32}, ${r.lsw || 0})">${r.isFloat ? 'Set Float' : (r.uint32 ? 'Set U32' : 'Set')}</button>
                    </div>
                </div>
            `).join('');
        }

        // Update inverter status bar (only for inverter type)
        function updateInverterStatus() {
            const statusBar = document.getElementById('inverter-status-bar');
            const type = deviceTypes[currentID] || 'inverter';

            // Show only for inverter type
            if (type !== 'inverter') {
                statusBar.style.display = 'none';
                return;
            }
            statusBar.style.display = 'flex';

            if (!currentID || !state[currentID]) return;

            const regs = state[currentID];

            // Pump Status (0x2000: 1=Forward, 2=Reverse, 3=Jog Fwd, 4=Jog Rev, 0/5/6=Stopped)
            const controlCmd = regs[0x2000] || 0;
            const pumpEl = document.getElementById('pump-status');
            if (controlCmd === 1) {
                pumpEl.textContent = 'Forward';
                pumpEl.className = 'status-badge running';
            } else if (controlCmd === 2) {
                pumpEl.textContent = 'Reverse';
                pumpEl.className = 'status-badge running reverse';
            } else if (controlCmd === 3) {
                pumpEl.textContent = 'Jog Fwd';
                pumpEl.className = 'status-badge running jog';
            } else if (controlCmd === 4) {
                pumpEl.textContent = 'Jog Rev';
                pumpEl.className = 'status-badge running jog';
            } else {
                pumpEl.textContent = 'Stopped';
                pumpEl.className = 'status-badge stopped';
            }

            // Lock Status (0x8001: 0=Unlocked, other=Locked)
            const paramProtection = regs[0x8001] || 0;
            const lockEl = document.getElementById('lock-status');
            if (paramProtection !== 0) {
                lockEl.textContent = 'ðŸ”’ Locked';
                lockEl.className = 'status-badge locked';
            } else {
                lockEl.textContent = 'ðŸ”“ Unlocked';
                lockEl.className = 'status-badge unlocked';
            }

            // Start Command Mode (0x8200: 0=Keypad, 1=Terminal, 2=Comm)
            const startMode = regs[0x8200] || 0;
            const modeEl = document.getElementById('cmd-mode');
            if (startMode === 0) {
                modeEl.textContent = 'Keypad';
                modeEl.className = 'status-badge mode-keypad';
            } else if (startMode === 1) {
                modeEl.textContent = 'Terminal';
                modeEl.className = 'status-badge mode-terminal';
            } else if (startMode === 2) {
                modeEl.textContent = 'Comm';
                modeEl.className = 'status-badge mode-comm';
            } else {
                modeEl.textContent = `Mode ${startMode}`;
                modeEl.className = 'status-badge';
            }
        }

        function regenerateRegTable() {
            const type = deviceTypes[currentID] || 'inverter';
            let defaults = inverterRegs;
            if (type === 'flowmeter') defaults = flowMeterRegs;
            else if (type === 'energymeter') defaults = energyMeterRegs;

            const customs = customRegs[currentID] || [];
            allRegs = [...defaults, ...customs];
            const tbody = document.getElementById('reg-table-body');
            tbody.innerHTML = allRegs.map(r => {
                const addrHex = '0x' + r.a.toString(16).toUpperCase().padStart(4, '0');
                const is32Bit = r.isFloat || r.uint32;
                const addrDisplay = is32Bit && r.lsw ? `${addrHex}+${r.lsw - r.a}` : addrHex;
                const dataType = r.isFloat ? 'Float' : (r.uint32 ? 'UInt32' : 'UInt16');
                return `
                <tr id="row-${currentID}-${r.a}" data-float="${!!r.isFloat}" data-uint32="${!!r.uint32}" data-lsw="${r.lsw || 0}">
                    <td>${addrDisplay}</td>
                    <td>${r.n}${is32Bit ? ' <span style="color:#888;font-size:0.8em;">[' + dataType + ']</span>' : ''}</td>
                    <td><input type="text" id="tval-${r.a}" class="table-input" onchange="setRegDirect(this, ${r.a}, ${!!r.isFloat}, ${!!r.uint32}, ${r.lsw || 0})" placeholder="-"></td>
                    <td id="thex-${r.a}">-</td>
                </tr>
            `;
            }).join('');

            // Update values from state
            updateRegTableValues();
        }

        function updateRegTableValues() {
            if (!currentID) return;
            // Initialize state if not present
            if (!state[currentID]) state[currentID] = {};

            allRegs.forEach(r => {
                const tval = document.getElementById(`tval-${r.a}`);
                const thex = document.getElementById(`thex-${r.a}`);
                if (!tval) return;

                if (r.isFloat && r.lsw) {
                    const msw = state[currentID][r.a] || 0;
                    const lsw = state[currentID][r.lsw] || 0;
                    const floatVal = registersToFloat(msw, lsw, r.leWords);
                    tval.value = floatVal.toFixed(3);
                    thex.innerText = `0x${msw.toString(16).toUpperCase().padStart(4, '0')} ${lsw.toString(16).toUpperCase().padStart(4, '0')}`;
                } else if (r.uint32 && r.lsw) {
                    const msw = state[currentID][r.a] || 0;
                    const lsw = state[currentID][r.lsw] || 0;
                    const uint32Val = (msw << 16) | lsw;
                    tval.value = uint32Val;
                    thex.innerText = `0x${uint32Val.toString(16).toUpperCase().padStart(8, '0')}`;
                } else {
                    const val = state[currentID][r.a] || 0;
                    tval.value = val;
                    thex.innerText = `0x${val.toString(16).toUpperCase().padStart(4, '0')}`;
                }
            });
        }

        // Convert 2x16bit registers to float
        // littleEndianWords: if true, LSW is at lower address (like CR009 flow meters)
        function registersToFloat(msw, lsw, littleEndianWords = false) {
            const buffer = new ArrayBuffer(4);
            const view = new DataView(buffer);
            if (littleEndianWords) {
                // Swap: treat first register as LSW, second as MSW
                view.setUint16(0, lsw, false);
                view.setUint16(2, msw, false);
            } else {
                // Big Endian word order (MSW first)
                view.setUint16(0, msw, false);
                view.setUint16(2, lsw, false);
            }
            return view.getFloat32(0, false);
        }

        function addCustomRegister() {
            const addrStr = document.getElementById('new-reg-addr').value;
            const name = document.getElementById('new-reg-name').value || "Custom";
            let addr;

            if (addrStr.toLowerCase().startsWith('0x')) {
                addr = parseInt(addrStr, 16);
            } else {
                addr = parseInt(addrStr); // Treat as decimal if no 0x prefix, or maybe require Hex? Let's assume Hex for input safety or check?
                // Actually user prompt said "Addr (Hex)" in my old code. 
                // Let's force Hex if user removed placeholder.
                // Assuming Hex input for consistency with technical users.
                addr = parseInt(addrStr, 16);
            }

            if (isNaN(addr)) { alert('Invalid Address (Hex)'); return; }

            if (!customRegs[currentID]) customRegs[currentID] = [];
            // Check duplicate
            if (customRegs[currentID].find(r => r.a === addr)) { alert('Register already in list'); return; }

            customRegs[currentID].push({ a: addr, n: name });
            regenerateRegTable();

            // Fetch value immediately
            socket.emit('get-register', { id: currentID, addr });

            // Create initial empty state if needed so it displays '-' until fetch
            if (state[currentID]) state[currentID][addr] = state[currentID][addr] || 0;
            // But we rely on socket response.
        }

        function setRegDirect(input, addr, isFloat = false, isUint32 = false, lswAddr = 0) {
            if (isFloat && lswAddr > 0) {
                const floatVal = parseFloat(input.value);
                if (!isNaN(floatVal)) {
                    const regs = floatToRegisters(floatVal);
                    socket.emit('set-register', { id: currentID, addr, val: regs.msw });
                    socket.emit('set-register', { id: currentID, addr: lswAddr, val: regs.lsw });
                }
            } else if (isUint32 && lswAddr > 0) {
                const uint32Val = parseInt(input.value);
                if (!isNaN(uint32Val)) {
                    const msw = (uint32Val >>> 16) & 0xFFFF;
                    const lsw = uint32Val & 0xFFFF;
                    socket.emit('set-register', { id: currentID, addr, val: msw });
                    socket.emit('set-register', { id: currentID, addr: lswAddr, val: lsw });
                }
            } else {
                const val = parseInt(input.value);
                if (!isNaN(val)) {
                    socket.emit('set-register', { id: currentID, addr, val });
                }
            }
        }


        function selectTab(id) {
            currentID = id;
            document.getElementById('current-id').innerText = id;
            document.getElementById('enable-checkbox').checked = inverterEnabled[id];

            const typeSelect = document.getElementById('device-type-select');
            typeSelect.value = deviceTypes[id] || 'inverter';

            // Update active tab style
            document.querySelectorAll('.tab-btn').forEach((btn, idx) => {
                const device = devicesList[idx];
                btn.classList.toggle('active', device && device.slaveId === id);
            });

            // Regenerate dashboard and register table for this device type
            regenerateDashboard();
            regenerateRegTable();

            // Refresh displayed values from state
            updateDashboardValues();
        }

        function updateDashboardValues() {
            if (!currentID || !state[currentID]) return;

            // Update inverter status bar first
            updateInverterStatus();

            map.forEach(r => {
                const valEl = document.getElementById(`val-${r.a}`);
                if (!valEl) return;

                if (r.isFloat && r.lsw) {
                    const msw = state[currentID][r.a] || 0;
                    const lsw = state[currentID][r.lsw] || 0;
                    const floatVal = registersToFloat(msw, lsw, r.leWords);
                    valEl.innerText = floatVal.toFixed(2);
                } else if (r.uint32 && r.lsw) {
                    const msw = state[currentID][r.a] || 0;
                    const lsw = state[currentID][r.lsw] || 0;
                    const uint32Val = (msw << 16) | lsw;
                    valEl.innerText = uint32Val;
                } else {
                    const val = state[currentID][r.a] || 0;
                    valEl.innerText = (val / r.s).toFixed(r.s > 1 ? 2 : 0);
                }
            });
        }

        function changeDeviceType(type) {
            if (!currentID) return;
            deviceTypes[currentID] = type;
            socket.emit('set-device-type', { id: currentID, type });

            // Regenerate UI
            updateTabs();
            regenerateDashboard();
            regenerateRegTable();
        }

        // --- Device Management ---
        function addDevice() {
            const slaveId = parseInt(document.getElementById('new-slave-id').value);
            const type = document.getElementById('new-device-type').value;

            if (slaveId < 1 || slaveId > 247) {
                alert('Slave ID must be between 1 and 247');
                return;
            }

            socket.emit('add-device', { slaveId, type });
            hideAddForm();
        }

        function removeCurrentDevice() {
            if (!currentID) return;
            if (confirm(`Remove device with Slave ID ${currentID}?`)) {
                socket.emit('remove-device', { slaveId: currentID });
            }
        }

        // --- Actions ---
        function startServer() {
            const port = document.getElementById('port-select').value;
            const baud = document.getElementById('baud-select').value;
            socket.emit('start-server', { port, baud });
        }

        function stopServer() {
            socket.emit('stop-server');
        }

        function toggleInverter(enabled) {
            if (!currentID) return;
            socket.emit('toggle-inverter', { id: currentID, enabled });
        }

        function setReg(addr, inputId, scale, isFloat = false, isUint32 = false, lswAddr = 0) {
            const val = parseFloat(document.getElementById(inputId).value);

            if (isFloat && lswAddr > 0) {
                // Pack float as IEEE 754 Big Endian (MSW, LSW)
                const floatRegs = floatToRegisters(val);
                socket.emit('set-register', { id: currentID, addr, val: floatRegs.msw });
                socket.emit('set-register', { id: currentID, addr: lswAddr, val: floatRegs.lsw });
            } else if (isUint32 && lswAddr > 0) {
                // Pack as 32-bit unsigned integer (MSW, LSW)
                const uint32Val = Math.round(val);
                const msw = (uint32Val >>> 16) & 0xFFFF;
                const lsw = uint32Val & 0xFFFF;
                socket.emit('set-register', { id: currentID, addr, val: msw });
                socket.emit('set-register', { id: currentID, addr: lswAddr, val: lsw });
            } else {
                const intVal = Math.round(val * scale);
                socket.emit('set-register', { id: currentID, addr, val: intVal });
            }
        }

        // Float to 2x16bit registers
        // littleEndianWords: if true, returns registers for LSW-first devices (like CR009)
        function floatToRegisters(value, littleEndianWords = false) {
            const buffer = new ArrayBuffer(4);
            const view = new DataView(buffer);
            view.setFloat32(0, value, false); // Store as Big Endian float
            const high = view.getUint16(0, false);
            const low = view.getUint16(2, false);
            if (littleEndianWords) {
                // For LSW-first devices: msw goes to higher addr, lsw goes to lower addr
                return { msw: low, lsw: high };
            }
            return { msw: high, lsw: low };
        }

        function sendCommand(cmd) {
            socket.emit('set-register', { id: currentID, addr: 0x2000, val: cmd });
        }

        // --- Socket Handling ---
        socket.on('server-status', (running) => {
            const badge = document.getElementById('status-badge');
            badge.innerText = running ? "RUNNING" : "STOPPED";
            badge.style.color = running ? "#4caf50" : "#f44336";
            document.getElementById('btn-start').disabled = running;
            document.getElementById('btn-stop').disabled = !running;
        });

        socket.on('log', (entry) => {
            const box = document.getElementById('log-box');
            const div = document.createElement('div');
            div.className = `log-entry log-${entry.type.toLowerCase()}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${entry.msg}`;
            box.appendChild(div);

            // Limit log entries to 100
            while (box.children.length > 100) {
                box.removeChild(box.firstChild);
            }

            box.scrollTop = box.scrollHeight;
        });

        socket.on('initial-state', (allData) => {
            for (const id in allData) {
                if (state[id]) {
                    for (const addr in allData[id]) {
                        state[id][parseInt(addr)] = allData[id][addr];
                    }
                }
            }
            selectTab(currentID); // Refresh UI
        });

        socket.on('reg-update', ({ id, addr, val }) => {
            if (state[id]) {
                state[id][addr] = val;
            }
            // If this is the currently viewed tab, update UI
            if (id === currentID) {
                updateDashboardValues();
                updateRegTableValues();
            }
        });

        socket.on('regs-update-batch', ({ id, updates }) => {
            if (state[id]) {
                Object.assign(state[id], updates);
            }
            // If this is the currently viewed tab, update UI
            if (id === currentID) {
                updateDashboardValues();
                updateRegTableValues();
            }
        });

        socket.on('register-value', ({ id, addr, val }) => {
            if (state[id]) state[id][addr] = val;

            if (id === currentID) {
                const tval = document.getElementById(`tval-${addr}`);
                const thex = document.getElementById(`thex-${addr}`);
                if (tval) {
                    tval.value = val;
                    thex.innerText = `0x${val.toString(16).toUpperCase().padStart(4, '0')}`;
                }
            }
        });

        socket.on('device-state', ({ id, type, registers }) => {
            // Update state with new register values
            state[id] = registers;
            deviceTypes[id] = type;
            if (id === currentID) {
                // Refresh displayed values
                map.forEach(r => {
                    const valEl = document.getElementById(`val-${r.a}`);
                    if (valEl) {
                        const val = state[id][r.a] || 0;
                        valEl.innerText = (val / r.s).toFixed(r.s > 1 ? 2 : 0);
                    }
                });
            }
        });

        // Dynamic devices list handler
        socket.on('devices-list', (list) => {
            devicesList = list;
            // Update internal state
            list.forEach(d => {
                state[d.slaveId] = state[d.slaveId] || {};
                inverterEnabled[d.slaveId] = d.enabled;
                deviceTypes[d.slaveId] = d.type;
            });

            updateTabs();

            // If no device selected, select first one
            if ((!currentID || !devicesList.find(d => d.slaveId === currentID)) && devicesList.length > 0) {
                selectTab(devicesList[0].slaveId);
            } else if (devicesList.length === 0) {
                currentID = null;
                document.getElementById('current-id').innerText = '-';
                document.getElementById('dashboard').innerHTML = '<p style="color:#888;">No devices. Click "+ Add Device" to add one.</p>';
                document.getElementById('reg-table-body').innerHTML = '';
            }
        });

        socket.on('device-added', ({ slaveId, type, enabled }) => {
            // Select the new device
            selectTab(slaveId);
        });

        socket.on('device-removed', ({ slaveId }) => {
            // If removed current device, select another
            if (slaveId === currentID && devicesList.length > 0) {
                const remaining = devicesList.filter(d => d.slaveId !== slaveId);
                if (remaining.length > 0) {
                    selectTab(remaining[0].slaveId);
                }
            }
        });

        socket.on('device-updated', ({ id, type, enabled }) => {
            // Update local state
            inverterEnabled[id] = enabled;
            deviceTypes[id] = type;
            const idx = devicesList.findIndex(d => d.slaveId === id);
            if (idx >= 0) {
                devicesList[idx] = { slaveId: id, type, enabled };
            }
            updateTabs();
            if (id === currentID) {
                document.getElementById('enable-checkbox').checked = enabled;
                document.getElementById('device-type-select').value = type;
                // Refresh UI to show correct dashboard/registers for new type
                selectTab(currentID);
            }
        });

        // COM Port Refresh Logic
        function refreshPorts() {
            const select = document.getElementById('port-select');
            const current = select.value;
            select.innerHTML = '<option>Refreshing...</option>';

            fetch('/api/ports')
                .then(res => res.json())
                .then(ports => {
                    select.innerHTML = '';
                    if (ports.length === 0) {
                        const opt = document.createElement('option');
                        opt.innerText = "No Ports Found";
                        select.appendChild(opt);
                    } else {
                        ports.forEach(port => {
                            const opt = document.createElement('option');
                            opt.value = port;
                            opt.innerText = port;
                            select.appendChild(opt);
                        });
                        // Restore selection if still exists
                        if (ports.includes(current)) {
                            select.value = current;
                        } else if (ports.length > 0) {
                            select.value = ports[0];
                        }
                    }
                })
                .catch(err => {
                    console.error('Failed to load ports:', err);
                    select.innerHTML = '<option>Error loading ports</option>';
                    // Log to bus traffic if possible?
                    // if(socket) socket.emit('log', ...); // Frontend logging
                });
        }

        // Initial Load
        refreshPorts();

    </script>
</body>

</html>