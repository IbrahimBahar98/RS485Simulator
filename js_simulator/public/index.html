<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modbus Device Simulator</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent: #007acc;
            --success: #4caf50;
            --error: #f44336;
            --border: #3e3e3e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            height: 100vh;
            box-sizing: border-box;
        }

        h1,
        h2,
        h3 {
            margin: 0 0 10px 0;
        }

        /* Top Bar */
        .top-bar {
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
        }

        select,
        input,
        button {
            background-color: #3d3d3d;
            border: 1px solid var(--border);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
        }

        button {
            background-color: var(--accent);
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            filter: brightness(1.1);
        }

        button:disabled {
            filter: grayscale(1);
            cursor: not-allowed;
        }

        button.stop-btn {
            background-color: var(--error);
        }

        button.run-btn {
            background-color: var(--success);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab-btn {
            padding: 10px 20px;
            background-color: #383838;
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            color: #aaa;
        }

        .tab-btn.active {
            background-color: var(--panel-bg);
            color: var(--accent);
            font-weight: bold;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            overflow: hidden;
        }

        /* Panels */
        .panel {
            background-color: var(--panel-bg);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .card {
            background-color: #383838;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .card-label {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 5px;
        }

        .card-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent);
        }

        .card-unit {
            font-size: 0.8em;
            color: #aaa;
        }

        .control-group {
            margin-top: 10px;
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .control-group input {
            width: 60px;
        }

        /* Actions */
        .action-bar {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Reg Table */
        .reg-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            margin-top: 15px;
        }

        .reg-table th,
        .reg-table td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }

        .reg-table th {
            color: #aaa;
        }

        .reg-val {
            font-family: monospace;
            color: var(--accent);
        }

        /* Logs */
        .log-container {
            flex: 1;
            background-color: #111;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin: 2px 0;
            border-bottom: 1px solid #222;
        }

        .log-rx {
            color: #4caf50;
        }

        .log-tx {
            color: #2196f3;
        }

        .log-err {
            color: #f44336;
        }

        .log-info {
            color: #aaa;
        }
    </style>
</head>

<body>

    <div class="top-bar">
        <h2>Device Simulator</h2>
        <select id="port-select">
            <option>Loading...</option>
        </select>
        <select id="baud-select">
            <option value="9600">9600</option>
            <option value="19200">19200</option>
        </select>
        <button id="btn-start" onclick="startServer()">Start Server</button>
        <button id="btn-stop" onclick="stopServer()" class="stop-btn" disabled>Stop Server</button>
        <span id="status-badge" style="margin-left:auto; color: #888;">Stopped</span>
    </div>

    <div class="tabs" id="tab-container">
        <!-- Generated by JS -->
    </div>

    <!-- Add Device Form -->
    <div id="add-device-form"
        style="display:none; background:#2d2d2d; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #3e3e3e;">
        <h3 style="margin-top:0;">Add New Device</h3>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <label>Slave ID: <input type="number" id="new-slave-id" min="1" max="247" value="1"
                    style="width:60px;"></label>
            <label>Type:
                <select id="new-device-type">
                    <option value="inverter">Inverter (FR500A)</option>
                    <option value="flowmeter">Flow Meter (CR009)</option>
                </select>
            </label>
            <button onclick="addDevice()" class="run-btn">Add Device</button>
            <button onclick="hideAddForm()" style="background:#666;">Cancel</button>
        </div>
    </div>

    <div class="main-grid">
        <div class="panel">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:10px;">
                <h3>Slave ID: <span id="current-id">-</span></h3>
                <select id="device-type-select" onchange="changeDeviceType(this.value)">
                    <option value="inverter">Inverter (FR500A)</option>
                    <option value="flowmeter">Flow Meter (CR009)</option>
                </select>
                <label style="font-size:0.8em;"><input type="checkbox" id="enable-checkbox" checked
                        onchange="toggleInverter(this.checked)">
                    Enabled</label>
                <button onclick="removeCurrentDevice()" class="stop-btn"
                    style="margin-left:auto; padding:5px 10px;">Remove Device</button>
            </div>
            <div class="dashboard" id="dashboard">
                <!-- Generated by JS -->
            </div>

            <h3 style="margin-top:20px;">Key Registers</h3>
            <div style="overflow-y:auto; flex:1; max-height:200px;">
                <table class="reg-table">
                    <thead>
                        <tr>
                            <th>Addr</th>
                            <th>Name</th>
                            <th>Value</th>
                            <th>Hex</th>
                        </tr>
                    </thead>
                    <tbody id="reg-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <h3>Bus Traffic</h3>
            <div class="log-container" id="log-box"></div>
            <button onclick="document.getElementById('log-box').innerHTML=''"
                style="margin-top:10px; background:#444;">Clear Log</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // Dynamic devices list (loaded from server)
        let devicesList = []; // Array of {slaveId, type, enabled}
        let currentID = null;

        // Per-ID state
        const state = {};
        const inverterEnabled = {};
        const deviceTypes = {};

        // ===== INVERTER Dashboard Cards =====
        const inverterMap = [
            { a: 0x3000, n: "Frequency", s: 100, u: "Hz" },
            { a: 0x3002, n: "Voltage", s: 10, u: "V" },
            { a: 0x3003, n: "Current", s: 10, u: "A" },
            { a: 0x3004, n: "Power", s: 10, u: "kW" },
            { a: 0x3005, n: "Speed", s: 1, u: "rpm" },
            { a: 0x3006, n: "Bus V", s: 10, u: "V" },
            { a: 0x3017, n: "Temp", s: 10, u: "°C" },
            { a: 0x3023, n: "Energy", s: 1, u: "kWh" }
        ];

        // ===== FLOW METER Dashboard Cards =====
        const flowMeterMap = [
            { a: 778, n: "Flow Rate", s: 1, u: "L/s", float: true, lsw: 779 },
            { a: 772, n: "Fwd Total", s: 1, u: "L", uint32: true, lsw: 773 },
            { a: 812, n: "Conductivity", s: 1, u: "μS/cm", float: true, lsw: 813 },
            { a: 777, n: "Alarms", s: 1, u: "flags" }
        ];

        // Current active map (changes based on device type)
        let map = inverterMap;

        // ===== INVERTER Registers =====
        const inverterRegs = [
            // Control (Write-only)
            { a: 0x2000, n: "Control Command" },
            // Status registers (Read-only) - 0x30xx Range
            { a: 0x3000, n: "Frequency Running" },
            { a: 0x3002, n: "Voltage Output" },
            { a: 0x3003, n: "Current Output" },
            { a: 0x3004, n: "Power Output" },
            { a: 0x3005, n: "Motor Speed (Est)" },
            { a: 0x3006, n: "Bus Voltage" },
            { a: 0x3017, n: "Inverter Temp" },
            { a: 0x3023, n: "Total Energy (kWh)" },
            { a: 0x3100, n: "Fault Code" },
            // Parameter registers - 0x8xxx
            { a: 0x8000, n: "User Password" },
            { a: 0x8001, n: "Display Params" },
            { a: 0x8006, n: "Param Edit Mode" },
            { a: 0x8200, n: "Start Cmd Mode" },
            { a: 0x840A, n: "Device ID" },
            // Mirrored addresses (0x03xx = U00 Group)
            { a: 0x0300, n: "U00.00 Frequency" },
            { a: 0x0302, n: "U00.02 Voltage" },
            { a: 0x0303, n: "U00.03 Current" }
        ];

        // ===== FLOW METER Registers =====
        const flowMeterRegs = [
            // Input Registers (FC 04) - Readings
            { a: 772, n: "Forward Total MSW" },
            { a: 773, n: "Forward Total LSW" },
            { a: 774, n: "Unit Info" },
            { a: 777, n: "Alarm Flags" },
            { a: 778, n: "Flow Rate MSW" },
            { a: 779, n: "Flow Rate LSW" },
            { a: 786, n: "Fwd Overflow Count" },
            { a: 812, n: "Conductivity MSW" },
            { a: 813, n: "Conductivity LSW" },
            // Holding Registers (FC 03) - Config
            { a: 261, n: "Flow Range MSW" },
            { a: 262, n: "Flow Range LSW" },
            { a: 281, n: "Alarm High MSW" },
            { a: 282, n: "Alarm High LSW" },
            { a: 284, n: "Alarm Low MSW" },
            { a: 285, n: "Alarm Low LSW" }
        ];

        // Current active registers (changes based on device type)
        let allRegs = inverterRegs;

        // --- Init ---
        async function init() {
            // Fetch Ports
            const res = await fetch('/api/ports');
            const ports = await res.json();
            const sel = document.getElementById('port-select');
            sel.innerHTML = ports.map(p => `<option value="${p}">${p}</option>`).join('');

            // Request devices list from server
            socket.emit('get-devices');
        }
        init();

        function updateTabs() {
            const tabContainer = document.getElementById('tab-container');
            let html = devicesList.map(d => {
                const label = d.type === 'flowmeter' ? 'FM' : 'INV';
                const opacity = d.enabled ? '1' : '0.5';
                return `<button class="tab-btn ${d.slaveId === currentID ? 'active' : ''}" style="opacity:${opacity}" onclick="selectTab(${d.slaveId})">${label} #${d.slaveId}</button>`;
            }).join('');
            html += `<button class="tab-btn" style="background:#4caf50;" onclick="showAddForm()">+ Add Device</button>`;
            tabContainer.innerHTML = html;
        }

        function showAddForm() {
            document.getElementById('add-device-form').style.display = 'block';
        }
        function hideAddForm() {
            document.getElementById('add-device-form').style.display = 'none';
        }

        function regenerateDashboard() {
            const type = deviceTypes[currentID] || 'inverter';
            map = type === 'flowmeter' ? flowMeterMap : inverterMap;

            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = map.map(r => `
                <div class="card">
                    <div class="card-label">${r.n}</div>
                    <div class="card-value" id="val-${r.a}">-</div>
                    <div class="card-unit">${r.u}</div>
                    <div class="control-group">
                        <input type="number" id="set-${r.a}" value="0" step="${r.float ? '0.1' : '1'}">
                        <button onclick="setReg(${r.a}, 'set-${r.a}', ${r.s}, ${!!r.float}, ${r.lsw || 0})">${r.float ? 'Set Float' : 'Set'}</button>
                    </div>
                </div>
            `).join('');
        }

        function regenerateRegTable() {
            const type = deviceTypes[currentID] || 'inverter';
            allRegs = type === 'flowmeter' ? flowMeterRegs : inverterRegs;

            const tbody = document.getElementById('reg-table-body');
            tbody.innerHTML = allRegs.map(r => `
                <tr id="row-${currentID}-${r.a}">
                    <td>${r.a.toString(10)}</td>
                    <td>${r.n}</td>
                    <td class="reg-val" id="tval-${r.a}">-</td>
                    <td class="reg-val" id="thex-${r.a}">-</td>
                </tr>
            `).join('');
        }

        function selectTab(id) {
            currentID = id;
            document.getElementById('current-id').innerText = id;
            document.getElementById('enable-checkbox').checked = inverterEnabled[id];

            // Update device type dropdown
            const typeSelect = document.getElementById('device-type-select');
            typeSelect.value = deviceTypes[id] || 'inverter';

            // Update active tab style
            document.querySelectorAll('.tab-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', SLAVE_IDS[idx] === id);
            });

            // Regenerate dashboard and register table for this device type
            regenerateDashboard();
            regenerateRegTable();

            // Refresh displayed values from state
            map.forEach(r => {
                const valEl = document.getElementById(`val-${r.a}`);
                if (valEl) {
                    const val = state[id][r.a] || 0;
                    valEl.innerText = (val / r.s).toFixed(r.s > 1 ? 2 : 0);
                }
            });
        }

        function changeDeviceType(type) {
            if (!currentID) return;
            deviceTypes[currentID] = type;
            socket.emit('set-device-type', { id: currentID, type });

            // Regenerate UI
            updateTabs();
            regenerateDashboard();
            regenerateRegTable();
        }

        // --- Device Management ---
        function addDevice() {
            const slaveId = parseInt(document.getElementById('new-slave-id').value);
            const type = document.getElementById('new-device-type').value;

            if (slaveId < 1 || slaveId > 247) {
                alert('Slave ID must be between 1 and 247');
                return;
            }

            socket.emit('add-device', { slaveId, type });
            hideAddForm();
        }

        function removeCurrentDevice() {
            if (!currentID) return;
            if (confirm(`Remove device with Slave ID ${currentID}?`)) {
                socket.emit('remove-device', { slaveId: currentID });
            }
        }

        // --- Actions ---
        function startServer() {
            const port = document.getElementById('port-select').value;
            const baud = document.getElementById('baud-select').value;
            socket.emit('start-server', { port, baud });
        }

        function stopServer() {
            socket.emit('stop-server');
        }

        function toggleInverter(enabled) {
            if (!currentID) return;
            socket.emit('toggle-inverter', { id: currentID, enabled });
        }

        function setReg(addr, inputId, scale, isFloat = false, lswAddr = 0) {
            const val = parseFloat(document.getElementById(inputId).value);

            if (isFloat && lswAddr > 0) {
                // Pack float as IEEE 754 Big Endian (MSW, LSW)
                const floatRegs = floatToRegisters(val);
                socket.emit('set-register', { id: currentID, addr, val: floatRegs.msw });
                socket.emit('set-register', { id: currentID, addr: lswAddr, val: floatRegs.lsw });
            } else {
                const intVal = Math.round(val * scale);
                socket.emit('set-register', { id: currentID, addr, val: intVal });
            }
        }

        // Float to 2x16bit registers (Big Endian)
        function floatToRegisters(value) {
            const buffer = new ArrayBuffer(4);
            const view = new DataView(buffer);
            view.setFloat32(0, value, false); // Big Endian
            return {
                msw: view.getUint16(0, false),
                lsw: view.getUint16(2, false)
            };
        }

        function sendCommand(cmd) {
            socket.emit('set-register', { id: currentID, addr: 0x2000, val: cmd });
        }

        // --- Socket Handling ---
        socket.on('server-status', (running) => {
            const badge = document.getElementById('status-badge');
            badge.innerText = running ? "RUNNING" : "STOPPED";
            badge.style.color = running ? "#4caf50" : "#f44336";
            document.getElementById('btn-start').disabled = running;
            document.getElementById('btn-stop').disabled = !running;
        });

        socket.on('log', (entry) => {
            const box = document.getElementById('log-box');
            const div = document.createElement('div');
            div.className = `log-entry log-${entry.type.toLowerCase()}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${entry.msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        });

        socket.on('initial-state', (allData) => {
            for (const id in allData) {
                if (state[id]) {
                    for (const addr in allData[id]) {
                        state[id][parseInt(addr)] = allData[id][addr];
                    }
                }
            }
            selectTab(currentID); // Refresh UI
        });

        socket.on('reg-update', ({ id, addr, val }) => {
            if (state[id]) {
                state[id][addr] = val;
            }
            // If this is the currently viewed tab, update UI
            if (id === currentID) {
                const mapItem = map.find(m => m.a === addr);
                if (mapItem) {
                    document.getElementById(`val-${addr}`).innerText = (val / mapItem.s).toFixed(mapItem.s > 1 ? 2 : 0);
                }
                // Update register table
                const tval = document.getElementById(`tval-${addr}`);
                const thex = document.getElementById(`thex-${addr}`);
                if (tval) {
                    tval.innerText = val;
                    thex.innerText = `0x${val.toString(16).toUpperCase().padStart(4, '0')}`;
                }
            }
        });
        socket.on('device-state', ({ id, type, registers }) => {
            // Update state with new register values
            state[id] = registers;
            deviceTypes[id] = type;
            if (id === currentID) {
                // Refresh displayed values
                map.forEach(r => {
                    const valEl = document.getElementById(`val-${r.a}`);
                    if (valEl) {
                        const val = state[id][r.a] || 0;
                        valEl.innerText = (val / r.s).toFixed(r.s > 1 ? 2 : 0);
                    }
                });
            }
        });

        // Dynamic devices list handler
        socket.on('devices-list', (list) => {
            devicesList = list;
            // Update internal state
            list.forEach(d => {
                state[d.slaveId] = state[d.slaveId] || {};
                inverterEnabled[d.slaveId] = d.enabled;
                deviceTypes[d.slaveId] = d.type;
            });

            updateTabs();

            // If no device selected, select first one
            if ((!currentID || !devicesList.find(d => d.slaveId === currentID)) && devicesList.length > 0) {
                selectTab(devicesList[0].slaveId);
            } else if (devicesList.length === 0) {
                currentID = null;
                document.getElementById('current-id').innerText = '-';
                document.getElementById('dashboard').innerHTML = '<p style="color:#888;">No devices. Click "+ Add Device" to add one.</p>';
                document.getElementById('reg-table-body').innerHTML = '';
            }
        });

        socket.on('device-added', ({ slaveId, type, enabled }) => {
            // Select the new device
            selectTab(slaveId);
        });

        socket.on('device-removed', ({ slaveId }) => {
            // If removed current device, select another
            if (slaveId === currentID && devicesList.length > 0) {
                const remaining = devicesList.filter(d => d.slaveId !== slaveId);
                if (remaining.length > 0) {
                    selectTab(remaining[0].slaveId);
                }
            }
        });

        socket.on('device-updated', ({ id, type, enabled }) => {
            // Update local state
            inverterEnabled[id] = enabled;
            deviceTypes[id] = type;
            const idx = devicesList.findIndex(d => d.slaveId === id);
            if (idx >= 0) {
                devicesList[idx] = { slaveId: id, type, enabled };
            }
            updateTabs();
            if (id === currentID) {
                document.getElementById('enable-checkbox').checked = enabled;
                document.getElementById('device-type-select').value = type;
            }
        });

    </script>
</body>

</html>